# Data Flow

This page explains how BloodCraftPlus synchronizes data between server and client.

## Overview

BloodCraftPlus uses a **chat-based protocol** to sync progression data:

1. Server generates progression updates
2. Data is encoded and sent via game chat
3. Client intercepts and parses messages
4. UI components render from cached state

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                          SERVER                                  │
│  ┌───────────────┐    ┌──────────────┐    ┌─────────────────┐  │
│  │ Game Events   │───▶│ Progression  │───▶│ EclipseService  │  │
│  │ (kills, etc.) │    │ Systems      │    │ (sync handler)  │  │
│  └───────────────┘    └──────────────┘    └────────┬────────┘  │
└────────────────────────────────────────────────────│────────────┘
                                                     │
                                    Chat Protocol    │
                                    (encoded data)   ▼
┌────────────────────────────────────────────────────│────────────┐
│                          CLIENT                    │            │
│  ┌────────────────┐    ┌──────────────┐    ┌──────┴─────────┐  │
│  │ UI Components  │◀───│ DataService  │◀───│ ChatSystem     │  │
│  │ (HUD, Menu)    │    │ (cache)      │    │ Patch          │  │
│  └────────────────┘    └──────────────┘    └────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Server Side

### Event Processing

When game events occur (kills, crafting, etc.):

1. **Harmony patches** intercept relevant game systems
2. **Progression systems** calculate updates (XP, expertise, etc.)
3. **Data is queued** for sync

### Sync Timing

Controlled by `Eclipsed` config:
- `true` — Fast sync (0.1s interval)
- `false` — Slow sync (2.5s interval)

### Data Encoding

`EclipseService` packages progression data:
- Multiple data types in single messages
- Efficient encoding for chat size limits
- Verification to prevent tampering

---

## Chat Protocol

### Message Format

Data is sent as specially formatted chat messages:
- Prefixed with identifiers
- Encoded payload
- Not visible in normal chat

### Data Types

| Type | Contents |
|------|----------|
| Progress | Level, XP, expertise, legacy |
| Familiar | Active familiar, box data |
| Class | Selected class, spells |
| Quest | Active quests, progress |
| Config | Server settings |

---

## Client Side

### Chat Interception

`ClientChatSystemPatch` intercepts incoming messages:
- Identifies BloodCraftPlus data packets
- Routes to appropriate handlers
- Suppresses from chat display

### Data Parsing

`DataService` processes incoming data:

```csharp
// Pseudo-code for data handling
void OnProgressData(string encoded) {
    var data = Decode(encoded);
    _levelData = data.Level;
    _expertiseData = data.Expertise;
    OnDataChanged?.Invoke();
}
```

### Caching

Parsed data is cached in `DataService`:
- Immediate availability for UI
- Persists until next sync
- Handles partial updates

---

## UI Binding

### Event-Driven Updates

UI components subscribe to data changes:

```csharp
// Pseudo-code for UI binding
class ExperienceBar : HudComponentBase {
    void OnEnable() {
        DataService.OnProgressChanged += Refresh;
    }
    
    void Refresh() {
        var level = DataService.CurrentLevel;
        var xp = DataService.CurrentXP;
        UpdateDisplay(level, xp);
    }
}
```

### Null Safety

Components handle missing data gracefully:
- Show placeholder states
- Hide when data unavailable
- Retry on next sync

---

## Key Files

### Server

| File | Purpose |
|------|---------|
| `Services/EclipseService.cs` | Sync orchestration |
| `Interfaces/EclipseInterface.cs` | Data packaging |

### Client

| File | Purpose |
|------|---------|
| `Services/DataService.cs` | Data cache + parsing |
| `Patches/ClientChatSystemPatch.cs` | Message interception |
| `Services/CanvasService.cs` | UI lifecycle |

---

## Troubleshooting

### Data Not Syncing

1. Check server has `Eclipsed` features enabled
2. Verify both mods are same version
3. Check for errors in client logs

### UI Not Updating

1. Wait for sync interval
2. Try closing/reopening menu
3. Check `DataService` has data

### Performance Issues

1. Set `Eclipsed = false` for slower sync
2. Check for excessive event spam
3. Monitor network/chat load
